# 需求文档

## 原始需求

做一个应用，将上传的 Excel 保存到数据库，然后可以通过 web 选择文件进行显示。通过 Docker 和侧载的方式部署应用，数据库使用 MySQL。

## 功能需求

### 认证功能

1. **用户注册**
   - 用户名注册（3-50个字符）
   - 邮箱验证
   - 密码最小长度6位
   - 注册后自动登录

2. **用户登录**
   - 用户名/密码登录
   - Session + Cookie 认证
   - Session 有效期24小时
   - 登录后清除旧会话

3. **用户登出**
   - 清除服务端会话
   - 清除客户端状态
   - 重定向到登录页

4. **数据隔离**
   - 用户只能访问自己的文件
   - 所有 API 请求需要认证
   - 文件上传关联当前用户
   - 图片下载验证用户权限

### 核心功能

5. **文件上传**
   - 支持 .xls 和 .xlsx 格式
   - 拖拽或点击上传
   - 文件大小限制：50MB
   - 显示上传进度
   - 文件关联当前用户

6. **文件存储**
   - 原始文件二进制存储（用于下载）
   - 解析数据结构化存储（用于展示）
   - 支持级联删除
   - 用户级数据隔离

7. **数据展示**
   - 表格形式展示 Excel 数据
   - 支持多 Sheet 切换
   - 支持分页浏览
   - 支持全量加载
   - 仅显示当前用户的文件

8. **文件管理**
   - 文件列表展示（仅当前用户）
   - 文件下载（原始文件）
   - 文件删除（仅当前用户的文件）

### 高级功能

9. **合并单元格支持**
   - 正确解析 Excel 中的合并单元格
   - 前端正确渲染合并效果（colspan/rowspan）
   - 合并单元格高亮显示

10. **内嵌图片支持**
   - 提取 Excel 中的内嵌图片
   - 图片存储到数据库
   - 前端展示图片缩略图
   - 点击预览大图
   - 显示图片锚定位置

11. **内嵌图表支持**
   - 识别 Excel 中的图表类型
   - 提取图表标题和位置信息
   - 前端展示图表元信息

12. **多表格区域支持**
   - 自动检测单个 Sheet 内的多个表格（通过空行分隔）
   - 支持切换查看不同表格区域
   - 自动识别表格名称

## 技术需求

### 技术栈

| 层级 | 技术 |
|------|------|
| 前端 | Vue 3 + Vite + Element Plus + Pinia |
| 后端 | Python + FastAPI + SQLAlchemy + Passlib |
| 数据库 | MySQL 8.0 |
| 部署 | Docker + Docker Compose |
| 认证 | Session + Cookie + bcrypt |

### 部署需求

1. **Docker 部署**
   - 使用 Docker Compose 编排服务
   - 支持一键启动

2. **侧载部署**
   - 支持导出 Docker 镜像
   - 支持离线环境部署

## 数据库设计

### 数据表

| 表名 | 说明 |
|------|------|
| users | 用户信息（用户名、邮箱、密码哈希） |
| sessions | 用户会话（session_id、过期时间） |
| excel_files | Excel 文件信息（包含原始文件二进制数据、user_id） |
| excel_sheets | Sheet 信息 |
| excel_data | 单元格数据 |
| merged_cells | 合并单元格信息 |
| sheet_images | 内嵌图片数据 |
| sheet_charts | 内嵌图表信息 |
| table_regions | 表格区域信息 |

## API 设计

### 认证 API

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/auth/register | 用户注册 |
| POST | /api/auth/login | 用户登录 |
| POST | /api/auth/logout | 用户登出 |
| GET | /api/auth/me | 获取当前用户信息 |

### 文件 API（需要认证）

| 方法 | 路径 | 说明 |
|------|------|------|
| POST | /api/upload | 上传 Excel 文件 |
| GET | /api/files | 获取当前用户的文件列表 |
| GET | /api/files/{id} | 获取文件详情 |
| GET | /api/files/{id}/sheets/{sheet_id}/data | 获取 Sheet 数据 |
| GET | /api/files/{id}/download | 下载文件 |
| GET | /api/images/{image_id} | 获取图片数据 |
| DELETE | /api/files/{id} | 删除文件 |

## 功能支持矩阵

| 特性 | .xlsx | .xls |
|------|-------|------|
| 单元格数据 | ✅ | ✅ |
| 合并单元格 | ✅ | ✅ |
| 内嵌图片 | ✅ | ❌ |
| 内嵌图表 | ✅ (元信息) | ❌ |
| 多表格区域 | ✅ | ✅ |

## 版本历史

### v3.0 (当前版本)
- 新增用户认证系统
- 新增用户注册/登录/登出功能
- 新增用户间数据隔离
- 所有 API 需要认证
- Session + Cookie 认证机制
- bcrypt 密码加密
- 新增用户状态管理（Pinia）

### v2.0
- 新增合并单元格支持
- 新增内嵌图片提取和展示
- 新增内嵌图表识别
- 新增多表格区域检测
- 重构前端表格组件

### v1.0
- 基础文件上传/下载/删除
- 数据表格展示
- 多 Sheet 支持
- 分页浏览
